<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump or Dump - Live Chart</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, linear-gradient(135deg, #1e3c72 0%, #2a5298 100%));
            color: var(--tg-theme-text-color, white);
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100vw;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, rgba(0, 0, 0, 0.3));
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--tg-theme-hint-color, rgba(255, 255, 255, 0.1));
            min-height: 50px;
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .round-info {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9em;
        }

        .timer {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--tg-theme-destructive-text-color, #ff4757);
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        .connection-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .connected {
            background: rgba(78, 205, 196, 0.3);
            color: #4ecdc4;
        }

        .disconnected {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 15px;
            overflow-y: auto;
        }

        .phase-indicator {
            text-align: center;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        .phase-betting {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);
        }

        .phase-revealing {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }

        .phase-waiting {
            background: linear-gradient(45deg, #ffd700, #f39c12);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .chart-container {
            background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 15px;
            border: 1px solid var(--tg-theme-hint-color, rgba(255, 255, 255, 0.1));
            position: relative;
            height: 250px;
            overflow: hidden;
        }

        .chart-container.betting-phase {
            border: 2px solid #FFD700;
            animation: betting-glow 1s ease-in-out infinite alternate;
        }

        .chart-container.revealing-phase {
            border: 2px solid #FF6B6B;
            animation: reveal-glow 0.5s ease-in-out infinite alternate;
        }

        @keyframes betting-glow {
            from { box-shadow: 0 0 15px #FFD700; }
            to { box-shadow: 0 0 25px #FFD700; }
        }

        @keyframes reveal-glow {
            from { box-shadow: 0 0 15px #FF6B6B; }
            to { box-shadow: 0 0 35px #FF6B6B; }
        }

        .pot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pot-card {
            background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.08));
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid var(--tg-theme-hint-color, rgba(255, 255, 255, 0.1));
        }

        .pot-card.pump {
            border-left: 3px solid #4ecdc4;
        }

        .pot-card.dump {
            border-left: 3px solid #ff6b6b;
        }

        .pot-card.total {
            border-left: 3px solid #ffd700;
        }

        .pot-card h4 {
            font-size: 0.8em;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .pot-card .value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .pot-card .percentage {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 2px;
        }

        .recent-bets {
            background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.08));
            border-radius: 12px;
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .recent-bets h4 {
            margin-bottom: 8px;
            color: var(--tg-theme-accent-text-color, #ffd700);
            font-size: 0.9em;
        }

        .bet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 6px;
            background: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.05));
            border-radius: 6px;
            font-size: 0.8em;
            animation: bet-appear 0.5s ease-out;
        }

        @keyframes bet-appear {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .bet-type {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
        }

        .bet-type.pump {
            background: #4ecdc4;
            color: white;
        }

        .bet-type.dump {
            background: #ff6b6b;
            color: white;
        }

        .result-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--tg-theme-bg-color, rgba(0,0,0,0.9));
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            text-align: center;
            border: 2px solid var(--tg-theme-accent-text-color, #FFD700);
            animation: result-appear 1s ease-out;
        }

        @keyframes result-appear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .telegram-branding {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.7em;
            opacity: 0.5;
            color: var(--tg-theme-hint-color, #888);
        }

        .demo-mode {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 165, 0, 0.9);
            color: black;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 100;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .header {
                padding: 8px 10px;
            }
            
            .header h1 {
                font-size: 1em;
            }
            
            .round-info {
                gap: 8px;
                font-size: 0.8em;
            }
            
            .main-content {
                padding: 8px;
                gap: 10px;
            }
            
            .chart-container {
                height: 200px;
                padding: 10px;
            }
            
            .pot-grid {
                gap: 8px;
            }
            
            .pot-card {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎰 Pump or Dump</h1>
            <div class="round-info">
                <div class="connection-status disconnected" id="connectionStatus">🔌 Connecting...</div>
                <div id="roundNumber">R#1</div>
                <div class="timer" id="timer">--</div>
            </div>
        </div>

        <div class="demo-mode" id="demoMode" style="display: none;">
            📡 Demo Mode - Connect to your bot server
        </div>

        <div class="main-content">
            <div class="phase-indicator phase-waiting" id="phaseIndicator">
                Connecting...
            </div>

            <div class="pot-grid">
                <div class="pot-card pump">
                    <h4>📈 PUMP</h4>
                    <div class="value" id="pumpAmount">0.000</div>
                    <div class="percentage" id="pumpPercent">0%</div>
                </div>
                <div class="pot-card dump">
                    <h4>📉 DUMP</h4>
                    <div class="value" id="dumpAmount">0.000</div>
                    <div class="percentage" id="dumpPercent">0%</div>
                </div>
                <div class="pot-card total">
                    <h4>👥 Players</h4>
                    <div class="value" id="playerCount">0</div>
                    <div class="percentage" id="totalPot">0.000 SOL</div>
                </div>
            </div>

            <div class="chart-container" id="chartContainer">
                <canvas id="priceChart"></canvas>
            </div>

            <div class="recent-bets">
                <h4>🔥 Live Activity</h4>
                <div id="recentBets">
                    <div style="text-align: center; opacity: 0.6; font-size: 0.8em;">
                        Waiting for bets...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="result-overlay" id="resultOverlay">
        📈 PUMP WINS! 📈
    </div>

    <div class="telegram-branding">
        Powered by Telegram Web Apps
    </div>

    <script>
        // Initialize Telegram Web App
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#1e3c72');
            tg.setBackgroundColor('#1e3c72');
            tg.enableClosingConfirmation();
            console.log('✅ Telegram Web App initialized');
        } else {
            console.log('⚠️ Not running in Telegram Web App - Demo mode');
            document.getElementById('demoMode').style.display = 'block';
        }

        // WebSocket connection
        let ws = null;
        let chart = null;
        let demoMode = false;
        let gameState = {
            round: 1,
            phase: 'waiting',
            timeLeft: 0,
            pumpPot: 0.0,
            dumpPot: 0.0,
            playerCount: 0,
            recentBets: []
        };

        // Chart initialization
        function initChart() {
            console.log('🎯 Initializing chart...');
            
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not loaded!');
                return false;
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            const data = generateChartData();
            
            try {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Price',
                            data: data.values,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        animation: { duration: 0 }
                    }
                });
                
                console.log('✅ Chart initialized successfully');
                return true;
            } catch (error) {
                console.error('❌ Chart initialization error:', error);
                return false;
            }
        }

        function generateChartData() {
            const labels = [];
            const values = [];
            let currentPrice = 100;
            
            for (let i = 0; i < 30; i++) {
                labels.push(i);
                const change = (Math.random() - 0.5) * 4;
                currentPrice += change;
                currentPrice = Math.max(70, Math.min(130, currentPrice));
                values.push(currentPrice);
            }
            
            return { labels, values };
        }

        function connectWebSocket() {
            const wsUrls = [
    'ws://pumpordump2024.loca.lt',  // Your new URL
    'wss://pumpordump2024.loca.lt',   // Try both wss and ws
    'ws://localhost:8765',
    'ws://127.0.0.1:8765'
];
            
            let urlIndex = 0;
            
            function tryConnect() {
                if (urlIndex >= wsUrls.length) {
                    console.log('🎭 Entering demo mode...');
                    enterDemoMode();
                    return;
                }
                
                const wsUrl = wsUrls[urlIndex];
                console.log(`🔌 Trying: ${wsUrl}`);
                
                try {
                    ws = new WebSocket(wsUrl);
                    
                    ws.onopen = function() {
                        console.log('✅ WebSocket connected');
                        updateConnectionStatus(true);
                        demoMode = false;
                        document.getElementById('demoMode').style.display = 'none';
                    };
                    
                    ws.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        handleGameUpdate(data);
                    };
                    
                    ws.onclose = function() {
                        console.log('❌ WebSocket disconnected');
                        updateConnectionStatus(false);
                        urlIndex++;
                        setTimeout(tryConnect, 2000);
                    };
                    
                    ws.onerror = function(error) {
                        console.log('❌ WebSocket error');
                        urlIndex++;
                        setTimeout(tryConnect, 1000);
                    };
                    
                } catch (error) {
                    console.error('❌ WebSocket creation failed:', error);
                    urlIndex++;
                    setTimeout(tryConnect, 1000);
                }
            }
            
            tryConnect();
        }

        function enterDemoMode() {
            console.log('🎭 Starting demo mode...');
            demoMode = true;
            document.getElementById('demoMode').style.display = 'block';
            updateConnectionStatus(false);
            
            startDemoSimulation();
        }

        function startDemoSimulation() {
            console.log('🎬 Demo simulation starting...');
            let demoRound = 1;
            
            function runDemoRound() {
                console.log(`🎲 Demo Round ${demoRound} starting`);
                
                gameState = {
                    round: demoRound,
                    phase: 'betting',
                    timeLeft: 20,
                    pumpPot: 0,
                    dumpPot: 0,
                    playerCount: 0,
                    recentBets: []
                };
                
                updateDisplay();
                document.getElementById('chartContainer').className = 'chart-container betting-phase';
                
                // Simulate bets
                let betCount = 0;
                const maxBets = Math.floor(Math.random() * 8) + 2;
                
                const bettingInterval = setInterval(() => {
                    if (betCount < maxBets && gameState.timeLeft > 5) {
                        const betType = Math.random() > 0.5 ? 'PUMP' : 'DUMP';
                        const amount = (Math.random() * 0.9 + 0.1).toFixed(1);
                        
                        if (betType === 'PUMP') {
                            gameState.pumpPot += parseFloat(amount);
                        } else {
                            gameState.dumpPot += parseFloat(amount);
                        }
                        
                        gameState.playerCount++;
                        gameState.recentBets.unshift({
                            type: betType,
                            amount: amount,
                            time: new Date().toLocaleTimeString()
                        });
                        
                        if (gameState.recentBets.length > 5) {
                            gameState.recentBets.pop();
                        }
                        
                        updateDisplay();
                        updateRecentBets();
                        moveChart(betType === 'PUMP' ? 2 : -2);
                        
                        betCount++;
                    }
                }, Math.random() * 3000 + 1000);
                
                // Countdown timer
                const timerInterval = setInterval(() => {
                    gameState.timeLeft--;
                    updateTimer(gameState.timeLeft);
                    
                    if (gameState.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        clearInterval(bettingInterval);
                        
                        gameState.phase = 'revealing';
                        updateDisplay();
                        document.getElementById('chartContainer').className = 'chart-container revealing-phase';
                        startRevealAnimation();
                        
                        setTimeout(() => {
                            const result = Math.random() > 0.5 ? 'PUMP' : 'DUMP';
                            showResult(result);
                            
                            gameState.phase = 'waiting';
                            updateDisplay();
                            document.getElementById('chartContainer').className = 'chart-container';
                            
                            demoRound++;
                            setTimeout(runDemoRound, 3000);
                        }, 5000);
                    }
                }, 1000);
            }
            
            setTimeout(runDemoRound, 2000);
        }

        function handleGameUpdate(data) {
            // Handle real WebSocket data here
            console.log('📨 Received:', data.type);
        }

        function updateDisplay() {
            document.getElementById('roundNumber').textContent = `R#${gameState.round}`;
            
            const total = gameState.pumpPot + gameState.dumpPot;
            const pumpPercent = total > 0 ? ((gameState.pumpPot / total) * 100).toFixed(1) : 0;
            const dumpPercent = total > 0 ? ((gameState.dumpPot / total) * 100).toFixed(1) : 0;
            
            document.getElementById('pumpAmount').textContent = gameState.pumpPot.toFixed(3);
            document.getElementById('dumpAmount').textContent = gameState.dumpPot.toFixed(3);
            document.getElementById('pumpPercent').textContent = `${pumpPercent}%`;
            document.getElementById('dumpPercent').textContent = `${dumpPercent}%`;
            document.getElementById('playerCount').textContent = gameState.playerCount;
            document.getElementById('totalPot').textContent = `${total.toFixed(3)} SOL`;
            
            const phaseIndicator = document.getElementById('phaseIndicator');
            phaseIndicator.className = `phase-indicator phase-${gameState.phase}`;
            
            switch(gameState.phase) {
                case 'betting':
                    phaseIndicator.textContent = '🔥 Betting Phase';
                    break;
                case 'revealing':
                    phaseIndicator.textContent = '🎲 Revealing...';
                    break;
                case 'waiting':
                    phaseIndicator.textContent = '⏳ Waiting...';
                    break;
            }
        }

        function updateTimer(timeLeft) {
            document.getElementById('timer').textContent = `${timeLeft}s`;
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = '🟢 LIVE';
                status.className = 'connection-status connected';
            } else {
                status.textContent = demoMode ? '🎭 DEMO' : '🔴 Offline';
                status.className = 'connection-status disconnected';
            }
        }

        function updateRecentBets() {
            const container = document.getElementById('recentBets');
            
            if (gameState.recentBets.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6; font-size: 0.8em;">Waiting for bets...</div>';
                return;
            }
            
            container.innerHTML = gameState.recentBets.map(bet => `
                <div class="bet-item">
                    <span class="bet-type ${bet.type.toLowerCase()}">${bet.type}</span>
                    <span>${bet.amount} SOL</span>
                    <span style="opacity: 0.7; font-size: 0.7em;">${bet.time}</span>
                </div>
            `).join('');
        }

        function moveChart(change = 0) {
            if (!chart) return;
            
            const currentData = [...chart.data.datasets[0].data];
            const lastValue = currentData[currentData.length - 1];
            
            const baseChange = (Math.random() - 0.5) * 3;
            const newValue = Math.max(70, Math.min(130, lastValue + baseChange + change));
            
            currentData.shift();
            currentData.push(newValue);
            
            chart.data.datasets[0].data = currentData;
            
            const isRising = newValue > lastValue;
            chart.data.datasets[0].borderColor = isRising ? '#4ecdc4' : '#ff6b6b';
            
            chart.update('none');
        }

        function startRevealAnimation() {
            let step = 0;
            const interval = setInterval(() => {
                if (chart) {
                    moveChart((Math.random() - 0.5) * 6);
                }
                step++;
                
                if (step >= 15) {
                    clearInterval(interval);
                }
            }, 300);
        }

        function showResult(result) {
            const overlay = document.getElementById('resultOverlay');
            overlay.textContent = result === 'PUMP' ? '📈 PUMP WINS! 📈' : '📉 DUMP WINS! 📉';
            overlay.style.display = 'block';
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 3000);
        }

        // Initialize everything
        window.addEventListener('load', () => {
            console.log('🚀 Chart loading...');
            
            setTimeout(() => {
                const chartReady = initChart();
                
                if (chartReady) {
                    console.log('✅ Chart ready, starting connections...');
                    connectWebSocket();
                    
                    setInterval(() => {
                        if (gameState.phase === 'betting') {
                            moveChart();
                        }
                    }, 1000);
                } else {
                    console.error('❌ Chart failed to initialize');
                }
            }, 1000);
        });
    </script>
</body>
</html>
